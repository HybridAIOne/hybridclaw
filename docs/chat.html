<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HybridClaw Chat</title>
  <style>
    :root {
      --page-bg: #ffffff;
      --panel-bg: #ffffff;
      --line: #ebeff5;
      --text: #1f2937;
      --muted: #8b98ab;
      --brand-blue: #4a6cf7;
      --brand-blue-2: #3657e9;
      --error: #d94848;
      --nav-width: 260px;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      height: 100%;
      font-family: system-ui, ui-sans-serif, -apple-system, BlinkMacSystemFont, Inter, NotoSansHans, sans-serif;
      background: var(--page-bg);
      color: var(--text);
    }

    .layout {
      position: relative;
      z-index: 1;
      height: 100vh;
      display: grid;
      grid-template-columns: var(--nav-width) 1fr;
    }

    .sidebar {
      background: rgb(241, 245, 249);
      padding: 14px 14px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-right: 1px solid #e3e8f0;
    }

    .sidebar-spacer {
      flex: 1 1 auto;
      min-height: 10px;
    }

    .app-version {
      font-size: 12px;
      line-height: 1.2;
      color: #8b98ab;
      padding: 2px 2px 0;
      user-select: none;
    }

    .sidebar-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: 2px 0 6px;
      gap: 8px;
    }

    .brand {
      padding: 0;
      border: none;
      border-radius: 0;
      background: transparent;
    }

    .brand-logo {
      width: 46px;
      max-width: 100%;
      display: block;
      height: auto;
    }

    .sidebar-toggle {
      width: 34px;
      height: 34px;
      border: none;
      border-radius: 0;
      background: transparent;
      color: #96a0af;
      display: grid;
      place-items: center;
      cursor: pointer;
      padding: 0;
      transition: color 0.2s ease;
    }

    .sidebar-toggle:hover {
      color: #6f7a8c;
    }

    .sidebar-toggle svg {
      width: 22px;
      height: 22px;
      display: block;
    }

    .new-chat-btn {
      width: 100%;
      border: none;
      padding: 10px 2px;
      font: inherit;
      cursor: pointer;
      background: transparent;
      color: #374151;
      text-align: left;
      transition: color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      font-weight: 500;
    }

    .new-chat-btn:hover {
      color: #111827;
    }

    .new-chat-icon {
      width: auto;
      height: auto;
      display: inline-block;
      font-size: 36px;
      line-height: 1;
      color: #4b5563;
      transform: translateY(-1px);
    }

    .layout.is-sidebar-collapsed {
      grid-template-columns: 84px 1fr;
    }

    .layout.is-sidebar-collapsed .new-chat-label {
      display: none;
    }

    .layout.is-sidebar-collapsed .new-chat-btn {
      justify-content: center;
      padding-left: 0;
      padding-right: 0;
    }

    .layout.is-sidebar-collapsed .brand-logo {
      width: 44px;
    }

    .chat {
      min-height: 0;
      display: grid;
      grid-template-rows: 1fr auto;
      background: #ffffff;
    }

    .chat-body {
      min-height: 0;
      display: grid;
      grid-template-rows: 1fr auto;
    }

    .messages {
      min-height: 0;
      overflow-y: auto;
      padding: 20px;
      display: grid;
      gap: 10px;
      align-content: start;
    }

    .msg {
      max-width: 860px;
      width: fit-content;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      background: #ffffff;
      color: #1f304d;
      white-space: pre-wrap;
      line-height: 1.45;
      box-shadow: 0 2px 8px rgba(50, 80, 140, 0.06);
    }

    .msg.markdown p {
      margin: 0;
    }

    .msg.markdown p + p {
      margin-top: 10px;
    }

    .msg.markdown h1,
    .msg.markdown h2,
    .msg.markdown h3 {
      margin: 0 0 8px;
      color: #172034;
      line-height: 1.2;
    }

    .msg.markdown h1 { font-size: 21px; }
    .msg.markdown h2 { font-size: 19px; }
    .msg.markdown h3 { font-size: 17px; }

    .msg.markdown ul,
    .msg.markdown ol {
      margin: 0;
      padding-left: 20px;
    }

    .msg.markdown ul + p,
    .msg.markdown ol + p,
    .msg.markdown p + ul,
    .msg.markdown p + ol {
      margin-top: 10px;
    }

    .msg.markdown blockquote {
      margin: 0;
      padding: 0 0 0 10px;
      border-left: 3px solid #d8dfeb;
      color: #4e6285;
    }

    .msg.markdown hr {
      border: none;
      border-top: 1px solid #d8dfeb;
      margin: 8px 0;
    }

    .msg.markdown code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.92em;
      background: #f2f5fa;
      color: #203a63;
      padding: 1px 5px;
      border-radius: 6px;
    }

    .msg.markdown pre {
      margin: 0;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #dde5f2;
      background: #f7f9fd;
      overflow-x: auto;
    }

    .msg.markdown pre code {
      background: transparent;
      padding: 0;
      border-radius: 0;
      color: #1f304d;
      display: block;
      line-height: 1.4;
    }

    .msg-block {
      max-width: 860px;
      width: fit-content;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .msg-actions {
      display: flex;
      justify-content: flex-start;
    }

    .copy-btn {
      border: none;
      background: transparent;
      color: #8b98ab;
      font-size: 14px;
      line-height: 1;
      padding: 2px 4px;
      cursor: pointer;
    }

    .copy-btn:hover {
      color: #4b5563;
    }

    .copy-btn.copied {
      color: #3657e9;
    }

    .msg.user {
      margin-left: auto;
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-blue-2));
      border-color: transparent;
      color: #ffffff;
    }

    .msg.assistant {
      background: #ffffff;
    }

    .msg.system {
      background: #f8faff;
      color: #4e6285;
    }

    .msg.thinking {
      min-width: 56px;
      padding: 14px 16px;
    }

    .thinking-dots {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .thinking-dots span {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #8b98ab;
      opacity: 0.25;
      animation: thinking-dot 1.1s infinite ease-in-out;
    }

    .thinking-dots span:nth-child(2) {
      animation-delay: 0.15s;
    }

    .thinking-dots span:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes thinking-dot {
      0%, 80%, 100% {
        opacity: 0.2;
        transform: translateY(0);
      }
      40% {
        opacity: 0.95;
        transform: translateY(-2px);
      }
    }

    .composer {
      border-top: 1px solid var(--line);
      padding: 14px 20px 16px;
      display: block;
      background: #ffffff;
    }

    .chat.is-empty .chat-body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
      gap: 22px;
    }

    .chat.is-empty .messages {
      display: none;
    }

    .empty-greeting {
      display: none;
      margin: 0;
      text-align: center;
      font-size: clamp(30px, 3.6vw, 54px);
      line-height: 1.08;
      font-weight: 620;
      letter-spacing: -0.02em;
      color: #172034;
    }

    .chat.is-empty .empty-greeting {
      display: block;
    }

    .chat.is-empty .composer {
      width: min(860px, 100%);
      border-top: none;
      padding: 0;
      background: transparent;
    }

    .prompt-wrap {
      position: relative;
    }

    .composer textarea {
      width: 100%;
      min-height: 56px;
      max-height: 180px;
      resize: vertical;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #ffffff;
      color: var(--text);
      padding: 11px 74px 14px 12px;
      font: inherit;
      line-height: 1.45;
      box-shadow: inset 0 1px 0 rgba(0, 0, 0, 0.02);
    }

    #send {
      position: absolute;
      right: 10px;
      bottom: 10px;
      border: none;
      border-radius: 999px;
      width: 44px;
      height: 44px;
      padding: 0;
      background: #8e95a4;
      color: #ffffff;
      display: grid;
      place-items: center;
      transition: background-color 0.2s ease;
    }

    #send:hover {
      background: #7c8393;
    }

    #send svg {
      width: 22px;
      height: 22px;
      display: block;
    }

    .error {
      min-height: 20px;
      color: var(--error);
      font-size: 13px;
      padding: 0 20px 14px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }

      .sidebar {
        border-right: none;
        border-bottom: 1px solid #e3e8f0;
      }

      .empty-greeting {
        font-size: clamp(22px, 6.8vw, 34px);
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="brand">
          <img
            class="brand-logo"
            src="https://hybridai.one/static/hai_logo_free.png"
            alt="HybridAI"
          >
        </div>
        <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="16" rx="4"></rect>
            <path d="M12 4v16"></path>
          </svg>
        </button>
      </div>

      <button id="newChat" class="new-chat-btn">
        <span class="new-chat-icon">+</span>
        <span class="new-chat-label">New Conversation</span>
      </button>
      <div class="sidebar-spacer"></div>
      <div id="appVersion" class="app-version">HybridClaw v...</div>
    </aside>

    <main class="chat">
      <div id="chatBody" class="chat-body">
        <section id="messages" class="messages"></section>
        <h1 class="empty-greeting">Ready to claw through your to-do list? ðŸ¦ž</h1>
        <div class="composer">
          <div class="prompt-wrap">
            <button id="send" aria-label="Send message">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M12 19V5"></path>
                <path d="m5 12 7-7 7 7"></path>
              </svg>
            </button>
            <textarea id="message" placeholder="Message HybridClaw"></textarea>
          </div>
        </div>
      </div>
      <div id="error" class="error"></div>
    </main>
  </div>

  <script>
    const layoutEl = document.querySelector('.layout');
    const chatEl = document.querySelector('.chat');
    const greetingEl = document.querySelector('.empty-greeting');
    const appVersionEl = document.getElementById('appVersion');
    const messageEl = document.getElementById('message');
    const messagesEl = document.getElementById('messages');
    const errorEl = document.getElementById('error');
    const urlParams = new URLSearchParams(window.location.search);
    const queryToken = urlParams.get('token') || '';
    let activeSessionId = localStorage.getItem('hybridclaw_session') || 'web:default';
    let activeSessionNumber = parseInt(localStorage.getItem('hybridclaw_session_number') || '1', 10);
    if (Number.isNaN(activeSessionNumber) || activeSessionNumber < 1) {
      activeSessionNumber = 1;
    }
    let lastSessionNumber = parseInt(localStorage.getItem('hybridclaw_last_session_number') || String(activeSessionNumber), 10);
    if (Number.isNaN(lastSessionNumber) || lastSessionNumber < activeSessionNumber) {
      lastSessionNumber = activeSessionNumber;
    }
    const apiToken = queryToken || localStorage.getItem('hybridclaw_token') || '';
    const introLines = [
      'Ready to claw through your to-do list? ðŸ¦ž',
      'What should we build, fix, or break first?',
      'Drop your wildest idea, Iâ€™ll sharpen it.',
      'Stuck? Letâ€™s turn chaos into a plan.',
      'Tell me the mission and Iâ€™ll bring the claws.',
      'Big question or tiny bug, Iâ€™m in.',
      'What are we shipping today?',
      'Letâ€™s make something clever in one prompt.',
      'Hit me with your hardest problem.',
      'Brainstorm mode activated. Whatâ€™s first?',
    ];
    let introIndex = 0;

    function renderIntro() {
      if (greetingEl) {
        greetingEl.textContent = introLines[introIndex];
      }
    }

    function savePrefs() {
      localStorage.setItem('hybridclaw_session', activeSessionId);
      localStorage.setItem('hybridclaw_session_number', String(activeSessionNumber));
      localStorage.setItem('hybridclaw_last_session_number', String(lastSessionNumber));
      if (apiToken) {
        localStorage.setItem('hybridclaw_token', apiToken);
      }
    }

    function updateWindowTitle() {
      document.title = `HybridClaw - (${activeSessionNumber})`;
    }

    function apiHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      if (apiToken) {
        headers.Authorization = `Bearer ${apiToken}`;
      }
      return headers;
    }

    function setError(text) {
      errorEl.textContent = text || '';
    }

    function escapeHtml(raw) {
      return String(raw)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function sanitizeUrl(rawUrl) {
      const url = String(rawUrl || '').trim();
      if (!url) return '';
      const lowered = url.toLowerCase();
      if (lowered.startsWith('http://') || lowered.startsWith('https://') || lowered.startsWith('mailto:')) {
        return url;
      }
      return '';
    }

    function renderInlineMarkdown(raw) {
      let text = String(raw || '');
      const inlineCode = [];
      const links = [];

      text = text.replace(/`([^`\n]+)`/g, (_match, code) => {
        const idx = inlineCode.push(`<code>${escapeHtml(code)}</code>`) - 1;
        return `@@IC${idx}@@`;
      });

      text = text.replace(/\[([^\]]+)\]\(([^)\s]+)\)/g, (_match, label, href) => {
        const safeHref = sanitizeUrl(href);
        const safeLabel = escapeHtml(label);
        const html = safeHref
          ? `<a href="${escapeHtml(safeHref)}" target="_blank" rel="noopener noreferrer">${safeLabel}</a>`
          : safeLabel;
        const idx = links.push(html) - 1;
        return `@@LK${idx}@@`;
      });

      text = escapeHtml(text);
      text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      text = text.replace(/__([^_]+)__/g, '<strong>$1</strong>');
      text = text.replace(/_([^_]+)_/g, '<em>$1</em>');

      text = text.replace(/@@LK(\d+)@@/g, (_match, index) => links[Number(index)] || '');
      text = text.replace(/@@IC(\d+)@@/g, (_match, index) => inlineCode[Number(index)] || '');
      return text;
    }

    function renderMarkdown(raw) {
      let text = String(raw || '').replace(/\r\n/g, '\n');
      const codeBlocks = [];

      text = text.replace(/```([^\n`]*)\n([\s\S]*?)```/g, (_match, _lang, code) => {
        const idx = codeBlocks.push(`<pre><code>${escapeHtml(code.replace(/\n$/, ''))}</code></pre>`) - 1;
        return `@@CB${idx}@@`;
      });

      const lines = text.split('\n');
      const out = [];
      let paragraphLines = [];
      let openList = '';

      const closeList = () => {
        if (openList) {
          out.push(openList === 'ul' ? '</ul>' : '</ol>');
          openList = '';
        }
      };

      const flushParagraph = () => {
        if (paragraphLines.length === 0) return;
        const html = paragraphLines.map((line) => renderInlineMarkdown(line)).join('<br>');
        out.push(`<p>${html}</p>`);
        paragraphLines = [];
      };

      for (const line of lines) {
        const codeMatch = line.match(/^@@CB(\d+)@@$/);
        if (codeMatch) {
          flushParagraph();
          closeList();
          out.push(codeBlocks[Number(codeMatch[1])] || '');
          continue;
        }

        if (!line.trim()) {
          flushParagraph();
          closeList();
          continue;
        }

        const heading = line.match(/^(#{1,3})\s+(.*)$/);
        if (heading) {
          flushParagraph();
          closeList();
          const level = heading[1].length;
          out.push(`<h${level}>${renderInlineMarkdown(heading[2])}</h${level}>`);
          continue;
        }

        const quote = line.match(/^>\s?(.*)$/);
        if (quote) {
          flushParagraph();
          closeList();
          out.push(`<blockquote>${renderInlineMarkdown(quote[1])}</blockquote>`);
          continue;
        }

        const hline = line.match(/^\s*((\*\s*){3,}|(-\s*){3,}|(_\s*){3,})\s*$/);
        if (hline) {
          flushParagraph();
          closeList();
          out.push('<hr>');
          continue;
        }

        const unordered = line.match(/^\s*[-*+]\s+(.*)$/);
        if (unordered) {
          flushParagraph();
          if (openList !== 'ul') {
            closeList();
            out.push('<ul>');
            openList = 'ul';
          }
          out.push(`<li>${renderInlineMarkdown(unordered[1])}</li>`);
          continue;
        }

        const ordered = line.match(/^\s*\d+\.\s+(.*)$/);
        if (ordered) {
          flushParagraph();
          if (openList !== 'ol') {
            closeList();
            out.push('<ol>');
            openList = 'ol';
          }
          out.push(`<li>${renderInlineMarkdown(ordered[1])}</li>`);
          continue;
        }

        closeList();
        paragraphLines.push(line);
      }

      flushParagraph();
      closeList();
      return out.join('');
    }

    function copyTextFallback(text) {
      const helper = document.createElement('textarea');
      helper.value = text;
      helper.setAttribute('readonly', '');
      helper.style.position = 'absolute';
      helper.style.left = '-9999px';
      document.body.appendChild(helper);
      helper.select();
      document.execCommand('copy');
      document.body.removeChild(helper);
    }

    async function copyMessage(content, button) {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(content);
        } else {
          copyTextFallback(content);
        }
        button.textContent = 'âœ“';
        button.classList.add('copied');
        window.setTimeout(() => {
          button.textContent = 'â§‰';
          button.classList.remove('copied');
        }, 900);
      } catch {
        copyTextFallback(content);
      }
    }

    function setAppVersion(version) {
      if (!appVersionEl) return;
      if (!version) {
        appVersionEl.textContent = 'HybridClaw v...';
        return;
      }
      appVersionEl.textContent = `HybridClaw v.${String(version).replace(/^v/i, '')}`;
    }

    function updateEmptyState() {
      const hasMessages = messagesEl.children.length > 0;
      chatEl.classList.toggle('is-empty', !hasMessages);
    }

    function addMessage(role, content) {
      const item = document.createElement('div');
      item.className = `msg ${role}`;
      if (role === 'assistant') {
        item.classList.add('markdown');
        item.innerHTML = renderMarkdown(content || '');
      } else {
        item.textContent = content || '';
      }
      if (role === 'assistant') {
        const block = document.createElement('div');
        block.className = 'msg-block';
        block.appendChild(item);

        const actions = document.createElement('div');
        actions.className = 'msg-actions';
        const copy = document.createElement('button');
        copy.type = 'button';
        copy.className = 'copy-btn';
        copy.setAttribute('aria-label', 'Copy response');
        copy.title = 'Copy response';
        copy.textContent = 'â§‰';
        copy.addEventListener('click', () => {
          void copyMessage(content || '', copy);
        });
        actions.appendChild(copy);
        block.appendChild(actions);
        messagesEl.appendChild(block);
      } else {
        messagesEl.appendChild(item);
      }
      updateEmptyState();
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addThinkingMessage() {
      const item = document.createElement('div');
      item.className = 'msg assistant thinking';
      const dots = document.createElement('span');
      dots.className = 'thinking-dots';
      for (let i = 0; i < 3; i += 1) {
        dots.appendChild(document.createElement('span'));
      }
      item.appendChild(dots);
      messagesEl.appendChild(item);
      updateEmptyState();
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return item;
    }

    async function requestJson(url, options) {
      const response = await fetch(url, options);
      const payload = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(payload.error || `${response.status} ${response.statusText}`);
      }
      return payload;
    }

    async function loadHistory() {
      savePrefs();
      setError('');
      messagesEl.innerHTML = '';
      updateEmptyState();
      try {
        const sessionId = encodeURIComponent(activeSessionId);
        const payload = await requestJson(`/api/history?sessionId=${sessionId}&limit=80`, {
          method: 'GET',
          headers: apiHeaders(),
        });
        for (const msg of payload.history || []) {
          addMessage(msg.role, msg.content);
        }
      } catch (err) {
        setError(err instanceof Error ? err.message : String(err));
      }
    }

    async function loadStatus() {
      try {
        const payload = await requestJson('/api/status', {
          method: 'GET',
          headers: apiHeaders(),
        });
        setAppVersion(payload.version || '');
      } catch {
        setAppVersion('');
      }
    }

    async function sendMessage() {
      const content = messageEl.value.trim();
      if (!content) return;

      savePrefs();
      setError('');
      addMessage('user', content);
      messageEl.value = '';
      const thinkingItem = addThinkingMessage();

      try {
        const payload = await requestJson('/api/chat', {
          method: 'POST',
          headers: apiHeaders(),
          body: JSON.stringify({
            sessionId: activeSessionId,
            channelId: 'web',
            userId: 'web-user',
            username: 'web',
            content,
          }),
        });
        if (payload.status === 'error') {
          throw new Error(payload.error || 'Unknown error');
        }
        thinkingItem.remove();
        addMessage('assistant', payload.result || '');
      } catch (err) {
        thinkingItem.remove();
        const text = err instanceof Error ? err.message : String(err);
        setError(text);
        addMessage('system', `Error: ${text}`);
      }
    }

    function newChat() {
      lastSessionNumber += 1;
      activeSessionNumber = lastSessionNumber;
      activeSessionId = `web:${Date.now()}`;
      messageEl.value = '';
      messagesEl.innerHTML = '';
      updateEmptyState();
      updateWindowTitle();
      savePrefs();
      setError('');
      messageEl.focus();
    }

    document.getElementById('send').addEventListener('click', () => {
      void sendMessage();
    });
    document.getElementById('newChat').addEventListener('click', newChat);
    document.getElementById('sidebarToggle').addEventListener('click', () => {
      layoutEl.classList.toggle('is-sidebar-collapsed');
    });
    messageEl.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        void sendMessage();
      }
    });
    introIndex = Math.floor(Math.random() * introLines.length);
    renderIntro();
    updateEmptyState();
    updateWindowTitle();
    savePrefs();
    void loadStatus();
    void loadHistory();
  </script>
</body>
</html>
